{% extends 'correction_system/base.html' %}
{% load custom_filters %}

{% block title %}题目详情 - 智学导师{% endblock %}

{% block extra_head %}
<style>
.problem-content {
    font-size: 16px;
    line-height: 1.6;
    background-color: rgba(248, 249, 250, 0.7);
}

.solution-content {
    font-size: 15px;
    line-height: 1.7;
    background-color: #fff;
    padding: 15px;
    border-radius: 5px;
}

.solution-content h3, 
.solution-content h4 {
    color: #4e6ef2;
    margin-top: 16px;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid rgba(78, 110, 242, 0.2);
}

/* 增强标题样式 */
.solution-content h4 {
    font-size: 17px;
}

/* 数学公式样式 */
.math {
    font-family: 'Times New Roman', Times, serif;
    font-style: italic;
}

/* 列表样式 */
.solution-list-item {
    margin-bottom: 10px;
    display: flex;
    align-items: baseline;
}

.solution-list-number {
    font-weight: bold;
    color: #4e6ef2;
    min-width: 24px;
    margin-right: 6px;
}

.solution-list-content {
    flex: 1;
}

/* 章节标题样式 */
.section-title {
    color: #4e6ef2;
    font-weight: bold;
    font-size: 17px;
    margin-top: 20px;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid rgba(78, 110, 242, 0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="container animation-fade-in py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'learning_history' %}" class="text-decoration-none text-primary">学习历史</a>
            <span class="mx-2">/</span>
            <a href="{% url 'problem_history' %}" class="text-decoration-none text-primary">题目历史</a>
            <span class="mx-2">/</span>
            <span class="fw-bold">题目详情</span>
        </div>
        <div>
            <a href="{% url 'create_knowledge_card' %}?problem_id={{ problem.id }}" class="btn me-2" style="background-color: #4e6ef2; color: white;">
                <i class="fas fa-lightbulb me-1"></i>生成知识卡片
            </a>
            <a href="{% url 'solve_problem' %}" class="btn" style="background-color: #4e6ef2; color: white;">
                <i class="fas fa-plus me-1"></i>解答新题目
            </a>
        </div>
    </div>
    
    <!-- 题目信息卡片 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #4e6ef2; color: white;">
            <div class="d-flex align-items-center">
                <i class="fas fa-question-circle me-2"></i>
                <h5 class="mb-0">{% if problem.problem_type == 'TEXT' %}文本题目{% else %}图片题目{% endif %}</h5>
            </div>
        </div>
        <div class="card-body">
            <h5 class="border-bottom pb-2 mb-3">题目内容：</h5>
            {% if problem.problem_type == 'TEXT' %}
                <div class="problem-content p-3 rounded">
                    {{ problem.problem_content }}
                </div>
            {% else %}
                <div class="text-center mb-3">
                    <img src="{{ problem.problem_image.url }}" alt="题目图片" class="img-fluid rounded border" style="max-height: 400px;">
                </div>
            {% endif %}
            <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted">提交时间: {{ problem.created_at|date:"Y-m-d H:i:s" }}</small>
                <span class="badge {% if problem.is_correct %}bg-success{% else %}bg-danger{% endif %} p-2">
                    {% if problem.is_correct %}
                        <i class="fas fa-check me-1"></i>回答正确
                    {% else %}
                        <i class="fas fa-times me-1"></i>回答错误
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    
    <!-- 用户答案 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #6c757d; color: white;">
            <div class="d-flex align-items-center">
                <i class="fas fa-pencil-alt me-2"></i>
                <h5 class="mb-0">我的答案</h5>
            </div>
        </div>
        <div class="card-body">
            {% if problem.user_answer %}
                <div class="solution-content">
                    {% with lines=problem.user_answer|split_lines %}
                        {% for line in lines %}
                            {% if line|startswith:"## " %}
                                <div class="section-title">{{ line|slice:"3:" }}</div>
                            {% elif line|startswith:"# " %}
                                <div class="section-title">{{ line|slice:"2:" }}</div>
                            {% elif line|matches:"^\d+\.\s.*" %}
                                <div class="solution-list-item">
                                    <span class="solution-list-number">{{ line|get_number }}.</span>
                                    <div class="solution-list-content">{{ line|strip_number }}</div>
                                </div>
                            {% else %}
                                <p>{{ line }}</p>
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
            {% else %}
                <p class="text-muted fst-italic">未提供解答</p>
            {% endif %}
        </div>
    </div>
    
    <!-- 标准解答 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #4e6ef2; color: white;">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>
                <h5 class="mb-0">标准解答</h5>
            </div>
        </div>
        <div class="card-body">
            {% if problem.solution %}
                <div class="solution-content">
                    {% with lines=problem.solution|split_lines %}
                        {% for line in lines %}
                            {% if line|startswith:"## " %}
                                <div class="section-title">{{ line|slice:"3:" }}</div>
                            {% elif line|startswith:"# " %}
                                <div class="section-title">{{ line|slice:"2:" }}</div>
                            {% elif line|matches:"^\d+\.\s.*" %}
                                <div class="solution-list-item">
                                    <span class="solution-list-number">{{ line|get_number }}.</span>
                                    <div class="solution-list-content">{{ line|strip_number }}</div>
                                </div>
                            {% else %}
                                <p>{{ line }}</p>
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
            {% else %}
                <p class="text-muted fst-italic">暂无标准解答</p>
            {% endif %}
        </div>
    </div>
    
    <!-- 解析补充说明 -->
    {% if problem.explanation %}
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #fd7e14; color: white;">
            <div class="d-flex align-items-center">
                <i class="fas fa-comment-dots me-2"></i>
                <h5 class="mb-0">解析补充</h5>
            </div>
        </div>
        <div class="card-body">
            <div class="solution-content">
                {% with lines=problem.explanation|split_lines %}
                    {% for line in lines %}
                        {% if line|startswith:"## " %}
                            <div class="section-title">{{ line|slice:"3:" }}</div>
                        {% elif line|startswith:"# " %}
                            <div class="section-title">{{ line|slice:"2:" }}</div>
                        {% elif line|matches:"^\d+\.\s.*" %}
                            <div class="solution-list-item">
                                <span class="solution-list-number">{{ line|get_number }}.</span>
                                <div class="solution-list-content">{{ line|strip_number }}</div>
                            </div>
                        {% else %}
                            <p>{{ line }}</p>
                        {% endif %}
                    {% endfor %}
                {% endwith %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 相关知识卡片 -->
    {% if related_cards %}
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #4e6ef2; color: white;">
            <div class="d-flex align-items-center">
                <i class="fas fa-lightbulb me-2"></i>
                <h5 class="mb-0">相关知识卡片</h5>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                {% for card in related_cards %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ card.title }}</h5>
                            <p class="card-text">{{ card.content|truncatechars:100 }}</p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{% url 'view_knowledge_card' card.id %}" class="btn btn-sm" style="background-color: #4e6ef2; color: white;">
                                <i class="fas fa-eye me-1"></i>查看详情
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 推荐学习资源 -->
    {% if recommended_resources %}
    <div class="card shadow-sm">
        <div class="card-header" style="background-color: #4e6ef2; color: white;">
            <div class="d-flex align-items-center">
                <i class="fas fa-book me-2"></i>
                <h5 class="mb-0">推荐学习资源</h5>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                {% for resource in recommended_resources %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ resource.title }}</h5>
                            <p class="card-text">{{ resource.description|truncatechars:100 }}</p>
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge {% if resource.resource_type == 'VIDEO' %}bg-danger{% elif resource.resource_type == 'ARTICLE' %}bg-info{% elif resource.resource_type == 'QUIZ' %}bg-warning{% else %}bg-secondary{% endif %} me-2">
                                    {{ resource.get_resource_type_display }}
                                </span>
                                {% if resource.avg_rating %}
                                <span class="text-warning">
                                    <i class="fas fa-star"></i>
                                    {{ resource.avg_rating|floatformat:1 }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{% url 'view_resource' resource.id %}" class="btn btn-sm" style="background-color: #4e6ef2; color: white;">
                                <i class="fas fa-eye me-1"></i>查看详情
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 